<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Reminders App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.9); }
        .icon-btn { transition: all 0.2s; }
        .icon-btn:hover { opacity: 0.8; transform: scale(1.05); }
        .reminder-item { transition: background-color 0.2s, box-shadow 0.2s; }
        .reminder-item:hover { background-color: #f0f4f8; }
        /* Style for the custom modal */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div id="custom-modal" class="card rounded-xl p-6 shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
            <p id="modal-message" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
        <header class="w-full max-w-2xl mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center mb-2">
                Real-Time Reminder App
            </h1>
            <p id="user-id-display" class="text-xs text-center text-gray-500 bg-yellow-100 p-1 rounded-lg shadow-inner"></p>
        </header>

        <main class="w-full max-w-2xl space-y-6">

            <!-- New Reminder Input Card -->
            <div class="card p-5 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Set a New Reminder</h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="reminder-text" placeholder="e.g., Call Jane about the project" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                    <input type="datetime-local" id="reminder-time" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                    <button id="add-reminder-btn" class="bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md whitespace-nowrap">
                        Add Reminder
                    </button>
                </div>
                <div id="input-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>

            <!-- Reminder List -->
            <div class="card p-5 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Your Upcoming Reminders</h2>
                <div id="reminders-list" class="space-y-3">
                    <p class="text-gray-500" id="loading-message">Loading reminders...</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, setLogLevel, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables provided by the Canvas environment
        
        // Define a minimal default config with a placeholder projectId AND an empty apiKey
        const defaultFirebaseConfig = { projectId: "default-canvas-project-id", apiKey: "" }; 
        
        // Merge the provided config with the default, ensuring projectId and apiKey are present
        const environmentConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const firebaseConfig = { ...defaultFirebaseConfig, ...environmentConfig };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth Setup ---
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Helper for custom modal
        function showCustomModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                const overlay = document.getElementById('modal-overlay');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                if (isConfirm) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                } else {
                    confirmBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }

                overlay.style.display = 'flex';

                const handleConfirm = () => {
                    overlay.style.display = 'none';
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    overlay.style.display = 'none';
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                if (isConfirm) {
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                } else {
                    cancelBtn.textContent = 'Close';
                    cancelBtn.style.display = 'inline-block';
                    cancelBtn.addEventListener('click', handleCancel);
                }
            });
        }
        
        // Helper to format time remaining
        function formatTimeRemaining(reminderTime) {
            const now = Date.now();
            const diffMs = reminderTime - now;

            if (diffMs <= 0) {
                return 'Overdue';
            }

            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) {
                return `in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            }
            if (diffHours > 0) {
                return `in ${diffHours} hour${diffHours !== 1 ? 's' : ''}`;
            }
            if (diffMinutes > 0) {
                return `in ${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''}`;
            }
            return `in ${diffSeconds} second${diffSeconds !== 1 ? 's' : ''}`;
        }

        // --- Core Application Logic ---

        // 1. Initial Authentication & Firestore Setup
        async function setupFirebase() {
            try {
                // Initialize Firebase services using the merged config
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                console.log("Firebase services initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no token is available or initial check is empty
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in
                            await signInAnonymously(auth);
                        }
                    }
                    // Once auth state is set, we are ready to proceed
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = `Your User ID: ${userId}`;
                    console.log("Authentication complete. User ID:", userId);
                    startReminderListener();
                });
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // Updated modal message to be slightly less opaque
                await showCustomModal("Error Initializing App", `A core configuration error persists. Please check the console for details. (Error: ${error.message})`);
            }
        }
        
        // 2. Data Listener (Read)
        function startReminderListener() {
            if (!isAuthReady || !db || !userId) return;

            // Firestore path for private user data
            const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
            
            // Query to get all reminders, sorted by time
            // NOTE: We avoid orderBy() to prevent index creation issues. We will sort in-memory.
            const q = query(remindersCollectionRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const reminders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    reminders.push({ id: doc.id, ...data });
                });

                // Sort reminders by time in memory
                reminders.sort((a, b) => {
                    const timeA = a.time?.toMillis ? a.time.toMillis() : Infinity;
                    const timeB = b.time?.toMillis ? b.time.toMillis() : Infinity;
                    return timeA - timeB;
                });
                
                renderReminders(reminders);
            }, (error) => {
                console.error("Error listening to reminders:", error);
                // If the error is permission denied, prompt the user
                if (error.code === 'permission-denied') {
                    showCustomModal("Access Denied", "Could not load reminders. Your user ID or app ID may be unauthorized. Check security rules.");
                } else {
                    showCustomModal("Error Loading Data", `Failed to load reminders. (Error: ${error.message})`);
                }
            });

            // Clean up the listener when the component would unmount (not strictly needed in this single-page script, but good practice)
            window.addEventListener('beforeunload', unsubscribe);
        }

        // 3. Data Renderer
        function renderReminders(reminders) {
            const listElement = document.getElementById('reminders-list');
            listElement.innerHTML = '';
            
            if (reminders.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500">You have no upcoming reminders. Add one above!</p>';
                return;
            }

            reminders.forEach(reminder => {
                const reminderTime = reminder.time?.toDate ? reminder.time.toDate().getTime() : null;
                const formattedDate = reminderTime ? new Date(reminderTime).toLocaleString() : 'No Date Set';
                const timeRemaining = reminderTime ? formatTimeRemaining(reminderTime) : '';
                const isOverdue = reminderTime && reminderTime < Date.now();
                const statusColor = isOverdue ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';

                const reminderDiv = document.createElement('div');
                reminderDiv.className = `reminder-item flex items-center p-4 rounded-lg shadow-sm border border-gray-200 ${isOverdue ? 'opacity-70' : ''}`;
                reminderDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-gray-800 font-medium">${reminder.text}</p>
                        <p class="text-sm text-gray-500">
                            <span class="font-semibold">${formattedDate}</span>
                            ${reminderTime ? `<span class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full ${statusColor}">${isOverdue ? 'OVERDUE' : timeRemaining}</span>` : ''}
                        </p>
                    </div>
                    <button class="delete-btn icon-btn ml-4 text-gray-400 hover:text-red-500" data-id="${reminder.id}">
                        <!-- Trash Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listElement.appendChild(reminderDiv);
            });
            
            // Re-attach listeners to the new delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
        }

        // 4. Data Writer (Create)
        async function handleAddReminder() {
            const textInput = document.getElementById('reminder-text');
            const timeInput = document.getElementById('reminder-time');
            const errorDiv = document.getElementById('input-error');

            const text = textInput.value.trim();
            const timeValue = timeInput.value;

            errorDiv.classList.add('hidden');
            
            if (!text || !timeValue) {
                errorDiv.textContent = 'Please provide both reminder text and a date/time.';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (!isAuthReady || !db || !userId) {
                showCustomModal("Authentication Error", "App is still loading or failed to authenticate. Please wait and try again.");
                return;
            }

            try {
                const reminder = {
                    text: text,
                    time: new Date(timeValue), // Firestore will convert this to a Timestamp
                    createdAt: serverTimestamp(),
                    isCompleted: false,
                };

                const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                await addDoc(remindersCollectionRef, reminder);

                // Clear inputs on success
                textInput.value = '';
                timeInput.value = '';
                console.log("Reminder added successfully.");

            } catch (error) {
                console.error("Error adding document:", error);
                showCustomModal("Database Error", `Failed to add reminder. (Error: ${error.message})`);
            }
        }

        // 5. Data Deleter (Delete)
        async function handleDelete(event) {
            const reminderId = event.currentTarget.dataset.id;

            const shouldDelete = await showCustomModal(
                "Confirm Deletion", 
                "Are you sure you want to delete this reminder?", 
                true
            );

            if (!shouldDelete || !isAuthReady || !db || !userId) {
                return;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reminders', reminderId);
                await deleteDoc(docRef);
                console.log("Reminder deleted successfully:", reminderId);
            } catch (error) {
                console.error("Error deleting document:", error);
                showCustomModal("Database Error", `Failed to delete reminder. (Error: ${error.message})`);
            }
        }


        // --- Event Listeners and Initial Load ---
        window.onload = function() {
            document.getElementById('add-reminder-btn').addEventListener('click', handleAddReminder);
            // Kick off the Firebase setup process
            setupFirebase();
        };

    </script>
</body>
</html>
