<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Reminder App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            max-width: 500px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .input-group {
            display: flex;
            gap: 0.5rem;
        }
        .input-field {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
        }
        .send-button {
            background-color: #4f46e5;
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
        }
        .send-button:hover {
            background-color: #4338ca;
        }
        .send-button:active {
            transform: scale(0.98);
        }
        .reminder-item {
            background-color: #f3f4f6;
            border-left: 5px solid #4f46e5;
            transition: all 0.2s ease-in-out;
        }
        .reminder-alerting {
            background-color: #fee2e2;
            border-left-color: #ef4444;
            animation: pulse-ring 1s infinite;
        }
        @keyframes pulse-ring {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        .log-box {
            background-color: #1f2937;
            color: #d1d5db;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            border-radius: 0.5rem;
        }
        /* Custom SVG for the Pen Icon */
        .pen-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body class="p-4">

    <div class="container-card">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Vocal Reminders</h1>
        <p class="text-gray-500 mb-6">Set, Snooze, Dismiss, or Delete tasks using natural language commands.</p>

        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Commands:</h2>
            <ul class="text-sm text-gray-600 space-y-1 ml-4 list-disc">
                <li>**Set**: `[Task]` **on/in/at** `[Time Phrase]`</li>
                <li>**Snooze**: `snooze` or `snooze for 5 minutes`</li>
                <li>**Dismiss**: `dismiss`</li>
                <li>**Delete**: `delete`</li>
            </ul>
        </div>

        <div class="input-group mb-4">
            <input type="text" id="commandInput" class="input-field" placeholder="e.g., remind me to drink water in 10s">
            <button id="sendButton" class="send-button">
                <svg class="pen-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
            </button>
        </div>

        <div id="outputLog" class="log-box p-3 mb-6 h-32 overflow-y-auto text-xs">
            System ready. Type a command to begin.
        </div>

        <h2 class="text-xl font-bold text-gray-900 mb-3">Active Reminders (<span id="reminderCount">0</span>)</h2>
        <div id="reminderListContainer" class="space-y-3">
            <!-- Reminder items will be injected here -->
        </div>
    </div>

    <script>
        // --- Core Setup ---
        let reminderList = [];
        let reminderIdCounter = 1;
        
        // Use Tone.js for simple audio feedback (no external file needed)
        let alertSynth;
        
        // Initialize the synth for an audible beep
        function initSynth() {
            // Check if Tone is available (it's not available in this environment, so we'll simulate)
            // We must use a simple HTML Audio element since external libraries like Tone.js are not guaranteed.
             // We will use a simple, in-browser generated audio context for a beep sound.
        }

        // Function to play a short beep
        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

                // Fade out quickly
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch (e) {
                console.error("Audio playback error:", e);
            }
        }
        
        // --- Utility Functions ---

        // Simple ID generator (since Firestore isn't used here, we rely on a counter)
        function generateId() {
            return `r-${reminderIdCounter++}`;
        }

        // Logs messages to the output log box
        function log(message) {
            const logElement = document.getElementById('outputLog');
            logElement.innerHTML += `> ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Finds the closest timestamp in the input to start parsing
        function findTimeKeywordIndex(text) {
            const keywords = ['on', 'in', 'at'];
            for (const keyword of keywords) {
                const index = text.toLowerCase().lastIndexOf(` ${keyword} `);
                if (index !== -1) {
                    return index + keyword.length + 1;
                }
            }
            return -1;
        }
        
        // Converts a time phrase (e.g., "5 minutes" or "next tuesday at 2pm") into a Date object
        function parseTimePhrase(phrase, baseDate = new Date()) {
            phrase = phrase.trim();
            if (!phrase) return null;

            // Simplified parsing for relative time (e.g., '5s', '10m', '1h')
            const relativeMatch = phrase.match(/^(\d+)\s*(s|sec|seconds|m|min|minutes|h|hr|hours|d|day|days)$/i);
            if (relativeMatch) {
                const value = parseInt(relativeMatch[1], 10);
                const unit = relativeMatch[2].toLowerCase();
                const newDate = new Date(baseDate.getTime());
                
                if (['s', 'sec', 'seconds'].includes(unit)) newDate.setSeconds(newDate.getSeconds() + value);
                else if (['m', 'min', 'minutes'].includes(unit)) newDate.setMinutes(newDate.getMinutes() + value);
                else if (['h', 'hr', 'hours'].includes(unit)) newDate.setHours(newDate.getHours() + value);
                else if (['d', 'day', 'days'].includes(unit)) newDate.setDate(newDate.getDate() + value);
                
                return newDate;
            }
            
            // For now, only simple relative time is supported for robustness.
            // Full date/time parsing is complex and requires a library (like Chrono).
            
            return null; // Return null if parsing fails
        }
        
        // Formats the Date object into a readable string
        function formatTime(date) {
            if (!date) return 'N/A';
            const now = new Date();
            const timeDifference = date.getTime() - now.getTime();
            
            if (timeDifference < 0) return 'Past Due';

            const seconds = Math.floor(timeDifference / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `in ${days} day(s)`;
            if (hours > 0) return `in ${hours} hr(s)`;
            if (minutes > 0) return `in ${minutes} min(s)`;
            if (seconds > 0) return `in ${seconds} sec(s)`;
            
            return 'Now';
        }

        // --- Reminder Actions ---

        // Adds or updates a reminder
        function handleSetTask(input) {
            const timeIndex = findTimeKeywordIndex(input);
            if (timeIndex === -1) {
                log('Error: Could not find a time keyword (on, in, at). Please rephrase.');
                return;
            }

            const taskDescription = input.substring(0, timeIndex - 4).trim();
            const timePhrase = input.substring(timeIndex).trim();
            const targetDate = parseTimePhrase(timePhrase);

            if (!targetDate) {
                log(`Error: Could not parse time phrase "${timePhrase}". Please use simple format (e.g., 5s, 10m, 1h).`);
                return;
            }

            const newReminder = {
                id: generateId(),
                task: taskDescription,
                targetTime: targetDate.getTime(),
                isAlerting: false,
                isDismissed: false,
                isDeleted: false,
            };

            reminderList.push(newReminder);
            log(`Task "${taskDescription}" set for ${targetDate.toLocaleTimeString()}.`);
            renderReminders();
        }

        function handleSnooze(id, timePhrase) {
            const reminder = reminderList.find(r => r.id === id);
            if (reminder) {
                const now = new Date();
                const snoozeTime = parseTimePhrase(timePhrase, now);

                if (!snoozeTime) {
                    log(`Error: Could not parse snooze time "${timePhrase}". Using default snooze time.`);
                    // Default snooze to 5 minutes if phrase is invalid or empty
                    snoozeTime = parseTimePhrase('5 minutes', now);
                }

                reminder.targetTime = snoozeTime.getTime();
                reminder.isAlerting = false;
                
                const timeStr = formatTime(snoozeTime);
                log(`Reminder "${reminder.task}" snoozed. New alert: ${timeStr}.`);
                renderReminders();
                playAlertSound(); // Stop the continuous alert sound (by immediately stopping the new one)
            }
        }

        function handleDismiss(id) {
            const reminder = reminderList.find(r => r.id === id);
            if (reminder) {
                reminder.isDismissed = true;
                reminder.isAlerting = false;
                log(`Reminder "${reminder.task}" dismissed. It remains in the list for reference.`);
                renderReminders();
                // Optionally stop sound if it was continuous
                playAlertSound(); 
            }
        }

        function handleDelete(id) {
            const reminder = reminderList.find(r => r.id === id);
            if (reminder) {
                reminder.isDeleted = true;
                reminder.isAlerting = false;
                log(`Reminder "${reminder.task}" deleted.`);
                renderReminders();
                // Optionally stop sound if it was continuous
                playAlertSound(); 
            }
        }
        
        // --- Input Handling ---

        function handleInput(input) {
            document.getElementById('commandInput').value = '';
            input = input.trim();
            if (!input) return;

            // 1. Find the currently alerting item (if any)
            const alertingItem = reminderList.find(r => r.isAlerting);
            const normalizedInput = input.toLowerCase();

            // --- CRITICAL FIX: Prioritize Alert Handling Commands ---
            if (alertingItem) {
                // Check for exact match for dismiss and delete
                if (normalizedInput === 'dismiss') {
                    handleDismiss(alertingItem.id);
                    return; // Crucial: Stop processing after handling the alert command
                }
                
                if (normalizedInput === 'delete') {
                    handleDelete(alertingItem.id);
                    return; // Crucial: Stop processing after handling the alert command
                }
                
                // Check for snooze (allows for variations like "snooze" or "snooze for 5s")
                if (normalizedInput.startsWith('snooze')) {
                    const timePhrase = input.substring('snooze'.length).trim() || '5 minutes'; // Default snooze time
                    handleSnooze(alertingItem.id, timePhrase);
                    return; // Crucial: Stop processing after handling the alert command
                }

                // If an item is alerting but the input is none of the alert commands,
                // we fall through to the new task setting logic below.
            }
            // --- End CRITICAL FIX Block ---
            
            // 2. If no alert command was processed, treat it as a new task command.
            handleSetTask(input);
        }

        // --- Rendering ---

        function renderReminders() {
            const container = document.getElementById('reminderListContainer');
            const countElement = document.getElementById('reminderCount');
            
            const activeReminders = reminderList.filter(r => !r.isDeleted);
            
            container.innerHTML = activeReminders.map(r => {
                const isPastDue = r.targetTime < Date.now();
                const isAlertingClass = r.isAlerting ? 'reminder-alerting' : '';
                const timeText = r.isDismissed ? 'DISMISSED' : formatTime(new Date(r.targetTime));
                const statusColor = r.isDismissed ? 'text-gray-400' : (r.isAlerting ? 'text-red-600 font-bold' : (isPastDue ? 'text-orange-500' : 'text-indigo-600'));
                
                return `
                    <div class="reminder-item p-4 rounded-lg flex justify-between items-center ${isAlertingClass}">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${r.task}</p>
                            <p class="text-sm ${statusColor}">Status: ${timeText}</p>
                        </div>
                        <!-- Optional action buttons can be added here -->
                    </div>
                `;
            }).join('');

            countElement.textContent = activeReminders.length;
        }

        // --- Main Loop and Event Listeners ---

        // The main check loop runs every second
        function checkReminders() {
            const now = Date.now();
            let isAnyAlerting = false;

            reminderList.forEach(r => {
                if (!r.isDismissed && !r.isDeleted && !r.isAlerting && r.targetTime <= now) {
                    r.isAlerting = true;
                    log(`ALERT: "${r.task}" is due! Type 'dismiss', 'delete', or 'snooze for [time]'.`);
                }
                if (r.isAlerting) {
                    isAnyAlerting = true;
                }
            });

            if (isAnyAlerting) {
                playAlertSound();
            }

            renderReminders();
        }

        // Initialize and bind events
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('sendButton').addEventListener('click', () => {
                const input = document.getElementById('commandInput').value;
                handleInput(input);
            });

            document.getElementById('commandInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const input = document.getElementById('commandInput').value;
                    handleInput(input);
                }
            });

            // Start the check loop
            setInterval(checkReminders, 1000);

            // Initialize the audio synth on user interaction
            document.body.addEventListener('click', initSynth, { once: true });
        });
    </script>
</body>
</html>
